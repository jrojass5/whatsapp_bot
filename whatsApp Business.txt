from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager
import time
import random
import os

# ==============================
# CONFIGURACIÃ“N
# ==============================

numeros = [
    
]

mensajes_normal = [
    "Hola ðŸ‘‹",
    "Te escribo desde cuenta normal",
    "Este es un mensaje con informacion importante",
    "Saludos!"
]

mensajes_business = [
    "Hola ðŸ’¼",
    "Mensaje desde cuenta business",
    "InformaciÃ³n importante",
    "Quedamos atentos."
]

# Crear carpetas de perfil
os.makedirs("perfil_normal", exist_ok=True)
os.makedirs("perfil_business", exist_ok=True)

service = Service(ChromeDriverManager().install())

# ==============================
# FUNCIONES
# ==============================

def crear_driver(ruta_perfil):
    options = Options()
    options.add_argument(f"user-data-dir={os.path.abspath(ruta_perfil)}")
    options.add_argument("--start-maximized")
    return webdriver.Chrome(service=service, options=options)

def esperar_whatsapp(driver, nombre):
    driver.get("https://web.whatsapp.com/")
    print(f"Escanea QR para cuenta {nombre} si es primera vez...")
    WebDriverWait(driver, 60).until(
        EC.presence_of_element_located((By.ID, "pane-side"))
    )
    print(f"Cuenta {nombre} lista âœ…")

def escribir_como_humano(elemento, texto):
    for letra in texto:
        elemento.send_keys(letra)
        time.sleep(random.uniform(0.05, 0.15))

def enviar_mensajes(driver, lista_mensajes, nombre_cuenta):
    for numero in numeros:
        print(f"[{nombre_cuenta}] Enviando a {numero}...")

        driver.get(f"https://web.whatsapp.com/send?phone={numero}&app_absent=0")

        try:
            # Esperar que el chat cargue
            WebDriverWait(driver, 30).until(
                EC.presence_of_element_located((By.ID, "main"))
            )

            # Seleccionar caja correcta (NO el buscador)
            caja = WebDriverWait(driver, 30).until(
                EC.element_to_be_clickable(
                    (By.XPATH, '//footer//div[@contenteditable="true"][@role="textbox"]')
                )
            )

            caja.click()

            # Enviar los 4 mensajes
            for mensaje in lista_mensajes:
                escribir_como_humano(caja, mensaje)
                time.sleep(random.uniform(1, 2))
                caja.send_keys(Keys.ENTER)
                time.sleep(random.uniform(3, 5))

            print(f"[{nombre_cuenta}] Enviado correctamente a {numero} âœ…")

        except Exception as e:
            print(f"[{nombre_cuenta}] Error con {numero}: {e}")
            

def detectar_bloqueo(driver):
    try:
        bloqueo = driver.find_elements(By.XPATH, "//*[contains(text(),'automat')]")
        if bloqueo:
            print("âš  WhatsApp detectÃ³ automatizaciÃ³n. Deteniendo envÃ­os.")
            return True
        return False
    except:
        return False

# ==============================
# EJECUCIÃ“N
# ==============================

driver_normal = crear_driver("perfil_normal")
driver_business = crear_driver("perfil_business")

esperar_whatsapp(driver_normal, "NORMAL")
esperar_whatsapp(driver_business, "BUSINESS")

print("Enviando desde cuenta NORMAL...")
enviar_mensajes(driver_normal, mensajes_normal, "NORMAL")

print("Enviando desde cuenta BUSINESS...")
enviar_mensajes(driver_business, mensajes_business, "BUSINESS")

print("Proceso finalizado ðŸš€")